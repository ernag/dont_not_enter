/*
 * wifi_stress_test.c
 *
 *  Created on: Jul 30, 2013
 *      Author: Chris
 */

#include "unit_tests.h"
#ifdef ENABLE_WHISTLE_UNIT_TESTS

#include "wifi_mgr.h"
#include "assert.h"

#if 0
char *data = "123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890";

void wifi_stress_ut(void)
{
    int sock_peer;  /* Foreign socket.*/
    int_32 bytes_sent;
    int count = 0;
    
    WIFIMGR_connect("Sasha", NULL, TRUE);
    
    WIFIMGR_open("192.168.168.144", 3000, &sock_peer, SOCK_STREAM_TYPE);
    
    while(1)
    {
    	WIFIMGR_send(sock_peer, (unsigned char *)data, strlen(data), &bytes_sent);
    	_time_delay(1);
    }
}
#endif

char *data = "12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890";
extern A_UINT32 wifi_connected_flag;

void wifi_stress_ut(void)
{ 
	A_INT32 sock_peer, a_rc, send_result;
	A_UINT8 *buffer;
	A_INT32 bytes_to_send;
	A_UINT8 toggle = 0;
	_ip_address remote_addr;
	SOCKADDR_T foreign_addr;
	_enet_handle driver_handle;
	char dumb[4] = {' ', ' ', ' ', ' '};
	int stupid;
	
	memcpy(&stupid, dumb, 4);
	
    whistle_atheros_init(&driver_handle);
    
    set_callback();

	whistle_set_passphrase("walle~12");
	whistle_set_wpa("wpa2", 8, 8);
	whistle_connect_handler("Sasha");

	while (!wifi_connected_flag)
	{
		_time_delay(1000);		
	}

	assert(A_OK == block_on_dhcp());

	sock_peer = t_socket((void *) driver_handle, ATH_AF_INET, SOCK_STREAM_TYPE, 0);

	ath_inet_aton("192.168.168.53", (A_UINT32 *) &remote_addr);

	memset(&foreign_addr, 0, sizeof(foreign_addr));
	foreign_addr.sin_addr = remote_addr;
	foreign_addr.sin_port = 3002;
	foreign_addr.sin_family = ATH_AF_INET;

	/* Connect to the server.*/
	a_rc = t_connect((void *) driver_handle, sock_peer, (&foreign_addr),
			sizeof(foreign_addr));

	bytes_to_send = strlen(data);
	
	// HACK TO MAKE SPI JUST LIKE TOWER CASE (On tower, SPI2 is used for Atheros)
	SPI0_CTAR0 = 0xbe000000;

	while(1)
	{
		while ((buffer = CUSTOM_ALLOC(bytes_to_send)) == NULL)
		{
			/*Allow small delay to allow other thread to run per Atheros example*/
			_time_delay(1);   // TODO: understand this delay and why its in ATH example.
		}

		/*
		 *   Insert white space in between to give an idea of thru-put.
		 */
		if( ++toggle % 2 )
		{
			memset(buffer, stupid, bytes_to_send);
		}
		else
		{
			memcpy(buffer, data, bytes_to_send);    
		}

		send_result = t_send((void *) driver_handle, sock_peer,
				(unsigned char *) (buffer),  bytes_to_send, 0);

		CUSTOM_FREE(buffer);
	}
}
#endif
